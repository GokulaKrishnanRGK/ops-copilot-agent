{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://opscopilot.dev/schemas/event_envelope.json",
  "title": "EventEnvelope",
  "type": "object",
  "oneOf": [
    { "$ref": "#/$defs/agent_run_started" },
    { "$ref": "#/$defs/scope_check_started" },
    { "$ref": "#/$defs/scope_check_completed" },
    { "$ref": "#/$defs/scope_check_rejected" },
    { "$ref": "#/$defs/planner_started" },
    { "$ref": "#/$defs/planner_completed" },
    { "$ref": "#/$defs/clarifier_started" },
    { "$ref": "#/$defs/clarifier_completed" },
    { "$ref": "#/$defs/clarifier_clarification_required" },
    { "$ref": "#/$defs/answer_started" },
    { "$ref": "#/$defs/answer_completed" },
    { "$ref": "#/$defs/assistant_token_delta" },
    { "$ref": "#/$defs/error_event" },
    { "$ref": "#/$defs/agent_run_failed" },
    { "$ref": "#/$defs/agent_run_completed" }
  ],
  "$defs": {
    "base": {
      "type": "object",
      "required": ["type", "timestamp", "session_id", "agent_run_id", "payload"],
      "properties": {
        "type": { "type": "string" },
        "timestamp": { "type": "string", "format": "date-time" },
        "session_id": { "type": "string" },
        "agent_run_id": { "type": "string" },
        "payload": { "type": "object" }
      },
      "additionalProperties": false
    },
    "empty_payload": {
      "type": "object",
      "maxProperties": 0,
      "additionalProperties": false
    },
    "agent_run_started": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "agent_run.started" },
            "payload": {
              "type": "object",
              "required": ["agent_run_id"],
              "properties": {
                "agent_run_id": { "type": "string" }
              },
              "additionalProperties": false
            }
          }
        }
      ]
    },
    "scope_check_started": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "scope_check.started" },
            "payload": { "$ref": "#/$defs/empty_payload" }
          }
        }
      ]
    },
    "scope_check_completed": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "scope_check.completed" },
            "payload": { "$ref": "#/$defs/empty_payload" }
          }
        }
      ]
    },
    "scope_check_rejected": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "scope_check.rejected" },
            "payload": {
              "type": "object",
              "required": ["response"],
              "properties": {
                "response": { "type": "string" }
              },
              "additionalProperties": false
            }
          }
        }
      ]
    },
    "planner_started": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "planner.started" },
            "payload": { "$ref": "#/$defs/empty_payload" }
          }
        }
      ]
    },
    "planner_completed": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "planner.completed" },
            "payload": { "$ref": "#/$defs/empty_payload" }
          }
        }
      ]
    },
    "clarifier_started": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "clarifier.started" },
            "payload": { "$ref": "#/$defs/empty_payload" }
          }
        }
      ]
    },
    "clarifier_completed": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "clarifier.completed" },
            "payload": { "$ref": "#/$defs/empty_payload" }
          }
        }
      ]
    },
    "clarifier_clarification_required": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "clarifier.clarification_required" },
            "payload": {
              "type": "object",
              "required": ["question"],
              "properties": {
                "question": { "type": "string" }
              },
              "additionalProperties": false
            }
          }
        }
      ]
    },
    "answer_started": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "answer.started" },
            "payload": { "$ref": "#/$defs/empty_payload" }
          }
        }
      ]
    },
    "answer_completed": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "answer.completed" },
            "payload": {
              "type": "object",
              "required": ["message"],
              "properties": {
                "message": { "type": "string" }
              },
              "additionalProperties": false
            }
          }
        }
      ]
    },
    "assistant_token_delta": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "assistant.token.delta" },
            "payload": {
              "type": "object",
              "required": ["text"],
              "properties": {
                "text": { "type": "string" },
                "source": { "type": "string" }
              },
              "additionalProperties": false
            }
          }
        }
      ]
    },
    "error_event": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "error" },
            "payload": {
              "type": "object",
              "required": ["error_type", "message", "context"],
              "properties": {
                "error_type": { "type": "string" },
                "message": { "type": "string" },
                "context": { "type": "object" }
              },
              "additionalProperties": false
            }
          }
        }
      ]
    },
    "agent_run_failed": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "agent_run.failed" },
            "payload": {
              "type": "object",
              "required": ["reason", "failure_type"],
              "properties": {
                "reason": { "type": "string" },
                "failure_type": { "type": "string" }
              },
              "additionalProperties": false
            }
          }
        }
      ]
    },
    "agent_run_completed": {
      "allOf": [
        { "$ref": "#/$defs/base" },
        {
          "properties": {
            "type": { "const": "agent_run.completed" },
            "payload": {
              "type": "object",
              "required": ["summary"],
              "properties": {
                "summary": { "type": "string" }
              },
              "additionalProperties": false
            }
          }
        }
      ]
    }
  }
}
