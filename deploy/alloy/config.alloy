local.file_match "opscopilot_logs" {
  path_targets = [
    {
      __path__ = "/var/log/opscopilot/**/*.log*",
      job      = "opscopilot",
    },
  ]
}

loki.source.file "opscopilot_logs" {
  targets    = local.file_match.opscopilot_logs.targets
  forward_to = [loki.process.opscopilot_logs.receiver]
}

loki.process "opscopilot_logs" {
  stage.json {
    expressions = {
      timestamp    = "timestamp",
      level        = "level",
      service      = "service",
      component    = "component",
      message      = "message",
      trace_id     = "trace_id",
      span_id      = "span_id",
      session_id   = "session_id",
      agent_run_id = "agent_run_id",
    }
  }

  stage.labels {
    values = {
      level        = "",
      service      = "",
      component    = "",
      trace_id     = "",
      session_id   = "",
      agent_run_id = "",
    }
  }

  stage.timestamp {
    source           = "timestamp"
    format           = "RFC3339"
    fallback_formats = ["RFC3339Nano"]
  }

  forward_to = [loki.write.default.receiver]
}

loki.write "default" {
  endpoint {
    url = "http://loki:3100/loki/api/v1/push"
  }
}
