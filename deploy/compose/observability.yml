services:
  loki:
    image: grafana/loki:3.1.1
    command: ["-config.file=/etc/loki/config.yml", "-log.format=json"]
    ports:
      - "3100:3100"
    volumes:
      - "../helm/observability/files/loki/config.yml:/etc/loki/config.yml:ro"
      - loki-data:/loki

  alloy:
    image: grafana/alloy:v1.5.1
    command: ["run", "/etc/alloy/config.alloy", "--server.http.listen-addr=0.0.0.0:12345"]
    volumes:
      - "../helm/observability/files/alloy/config.alloy:/etc/alloy/config.alloy:ro"
      - "${LOGS_HOST_PATH:-/tmp/opscopilot-logs}:/var/log/opscopilot:ro"
    depends_on:
      - loki

  tempo:
    image: grafana/tempo:2.6.0
    user: "0:0"
    command: ["-config.file=/etc/tempo/tempo.yml"]
    ports:
      - "3200:3200"
    volumes:
      - "../helm/observability/files/tempo/tempo.yml:/etc/tempo/tempo.yml:ro"
      - tempo-data:/tmp/tempo

  prometheus:
    image: prom/prometheus:v2.54.1
    command: ["--config.file=/etc/prometheus/prometheus.yml", "--log.format=json"]
    ports:
      - "9090:9090"
    volumes:
      - "../helm/observability/files/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro"
      - prometheus-data:/prometheus

  grafana:
    image: grafana/grafana:11.1.0
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: "${GRAFANA_ADMIN_USER:-admin}"
      GF_SECURITY_ADMIN_PASSWORD: "${GRAFANA_ADMIN_PASSWORD:-admin}"
      GF_LOG_MODE: "console"
      GF_LOG_CONSOLE_FORMAT: "json"
    volumes:
      - "../helm/observability/files/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro"
      - "../helm/observability/files/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro"
      - "../helm/observability/files/grafana/dashboards:/etc/grafana/dashboards:ro"
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
      - loki
      - tempo

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.103.0
    command: ["--config=/etc/otelcol/config.yaml"]
    ports:
      - "4317:4317"
      - "4318:4318"
      - "8889:8889"
      - "13133:13133"
    volumes:
      - "../helm/observability/files/otel/collector-config.yml:/etc/otelcol/config.yaml:ro"
    depends_on:
      - tempo
    healthcheck:
      test: ["CMD", "/otelcol-contrib", "--version"]
      interval: 2s
      timeout: 2s
      retries: 12

volumes:
  loki-data:
  tempo-data:
  prometheus-data:
  grafana-data:
